name: Deploy via SSH

on:
  push:
    branches:
      - main
  schedule:
    - cron: "30 4 2 1 *" 

   # 1. 30 ‚Üí Minuto (30 minutos ap√≥s o in√≠cio da hora)
   # 2. 4 ‚Üí Hora em UTC (4h UTC, que √© 1h no hor√°rio de Bras√≠lia)
   # 3. 2 ‚Üí Dia do m√™s (2¬∫ dia do m√™s)
   # 4. 1 ‚Üí M√™s (1¬∫ m√™s, janeiro)
   # 5. * ‚Üí Qualquer dia da semana (sem restri√ß√£o de dia espec√≠fico)

jobs:
  notify-and-schedule:
    name: Notify and Schedule
    runs-on: ubuntu-latest

    steps:
      # Enviar notifica√ß√£o de agendamento
      - name: Notify Scheduled Deploy to Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Deploy agendado com sucesso. üöÄ
            Reposit√≥rio: `${{ github.repository }}`
            Branch: `${{ github.ref_name }}`
            Commit: `${{ github.sha }}`
            Mensagem do Commit: "${{ github.event.head_commit.message }}"

      # Enviar notifica√ß√£o de agendamento
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_HOST }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Deploy agendado com sucesso!"
          body: |
            Deploy programado.
            Reposit√≥rio: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Mensagem do Commit: "${{ github.event.head_commit.message }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_USERNAME }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      # Checkout do c√≥digo
      - name: Checkout Code
        uses: actions/checkout@v3

      # Conex√£o via SSH e execu√ß√£o de comandos
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASS }}
          port: ${{ secrets.PORT }}
          script: |
            cd /caminho/do/seu/projeto   # Substitua pelo caminho do seu projeto
            git pull origin main

      # Notificar no Slack ap√≥s o deploy
      - name: Notify Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            Deploy realizado com sucesso no hor√°rio programado! üöÄ
            Reposit√≥rio: `${{ github.repository }}`
            Branch: `${{ github.ref_name }}`
            Commit: `${{ github.sha }}`
            Mensagem do Commit: "${{ github.event.head_commit.message }}"

      # Enviar notifica√ß√£o por e-mail ap√≥s o deploy
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_HOST }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Deploy realizado com sucesso!"
          body: |
            Deploy conclu√≠do com sucesso no hor√°rio agendado!
            Reposit√≥rio: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Mensagem do Commit: "${{ github.event.head_commit.message }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_USERNAME }}